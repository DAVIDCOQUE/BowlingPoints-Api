name: CI/CD Pipeline - BowlingPoints

on:
  push:
    branches:
      - dev
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-analyze:
    name: Build, Test and Analyze
    runs-on: ubuntu-latest

    steps:
      # üß© 1. Descarga el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # üß∞ 2. Configura Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu'
          cache: maven

      # ‚ö° 3. Cache de SonarQube
      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # üß± 4. Compila, ejecuta tests y genera reporte de cobertura
      - name: Build, test and generate JaCoCo report
        env:
          DB_URL: ${{ secrets.DB_URL }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "üèóÔ∏è Ejecutando build y tests..."
          mvn clean verify jacoco:report -B

      # üîç 5. Ejecuta an√°lisis SonarQube con cobertura de JaCoCo
      - name: üîç SonarQube analysis (with JaCoCo coverage)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          set -e
          echo "üöÄ Iniciando an√°lisis SonarQube..."
          mvn sonar:sonar \
            -Dsonar.projectKey=DAVIDCOQUE_BowlingPoints-Api \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            -Dsonar.java.binaries=target/classes

      # ‚úÖ 6. Verifica Quality Gate
      - name: Check SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@95b1cc6c02a15c8ecc00c07b1c2a75ed61a14055
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          scanMetadataReportFile: target/sonar/report-task.txt
      # ‚úÖ 7. Subir el JAR como artefacto
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: bowlingpoints-jar
          path: target/*.jar # Sube el archivo JAR generado por Maven

  docker-deploy:
    name: Build and Deploy Docker
    runs-on: ubuntu-latest
    needs: build-and-analyze

    steps:
      # üß© 1. Descarga el repo para el build Docker
      - name: Checkout repository
        uses: actions/checkout@v4

      # üì• 1.5. Descargar el JAR compilado desde el job anterior
      - name: Download JAR artifact
        uses: actions/download-artifact@f093f21ca4cfa7c75ccbbc2be54da76a0c7e1f05
        with:
          name: bowlingpoints-jar
          path: target/

      # üê≥ 2. Login a Docker Hub
      - name: Log in to Docker Hub
        # NOTA: Reemplazo tu SHA por el tag estable para evitar futuros fallos.
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASS }}

      # ‚öôÔ∏è 3. Construye imagen Docker
      - name: üê≥ Build Docker image
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          echo "üê≥ Construyendo imagen Docker..."
          docker build -t $DOCKERHUB_USERNAME/bowlingpoints:latest .

      # üöÄ 4. Publica en Docker Hub
      - name: üì¶ Push Docker image to Docker Hub
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_PASS }}
        run: |
          echo "üì¶ Iniciando publicaci√≥n en Docker Hub..."
          echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin
          docker push $DOCKERHUB_USERNAME/bowlingpoints:latest
          echo "‚úÖ Imagen publicada correctamente en Docker Hub."

      # ‚òÅÔ∏è 5. Despliega en AWS EC2
      - name: üöÄ Deploy to AWS via SSH
        uses: appleboy/ssh-action@3ca8a7c5359ac6ad91aa47f1946ece1c3b025004
        env:
          # Aqu√≠ defines tus variables "tipo .env"
          APP_PORTS: ${{ secrets.APP_PORTS }}
          DB_URL: ${{ secrets.DB_URL }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          # ... otras vars
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ec2-user
          key: ${{ secrets.AWS_SSH_KEY }}

          # üí° TRUCO: Usar el comando 'sh -c' para forzar la expansi√≥n local antes de enviar
          script: |
            echo "üöÄ Desplegando en AWS..."
            
          # Aqu√≠ usamos la sintaxis de shell de Linux para expandir las variables
          # La acci√≥n ssh-action lo interpreta y lo pasa correctamente al servidor
            docker pull $DOCKERHUB_USERNAME/bowlingpoints:latest
            docker stop bowlingpoints || true
            docker rm bowlingpoints || true
            
          # Comando RUN con las variables expandidas localmente
            docker run -d --name bowlingpoints -p "$APP_PORTS" \
              -e DB_URL="$DB_URL" \
              -e DB_USER="$DB_USER" \
              -e DB_PASSWORD="$DB_PASSWORD" \
              --restart always \
              $DOCKERHUB_USERNAME/bowlingpoints:latest
